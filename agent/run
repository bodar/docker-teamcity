#!/usr/bin/env bash
set -e

agent_zip=${TEAMCITY_SERVER_URL}/update/buildAgent.zip

until $(curl --output /dev/null --silent --head --fail ${agent_zip}); do
    echo Waiting for Teamcity Server (${TEAMCITY_SERVER_URL}) to be ready
    sleep 5
done

cd ${TEAMCITY_AGENT_DATA}

if [ ! -f "bin/agent.sh" ]; then
  wget -T 1 
  unzip buildAgent.zip
  rm buildAgent.zip
  chmod u+x bin/agent.sh
fi

if [ ! -f conf/buildAgent.properties ]; then
  envsubst < /opt/BuildAgent/buildAgent.properties.template > conf/buildAgent.properties
fi

exec bin/agent.sh run
